name: Build and Smoke Test 1

on:
  pull_request:
    branches:
      - 'main'
      - 'master'
      - 'rc/*'
      - 'integrate-sys-tests-ci'
      - 'integrate-sys-tests-ci2'
  workflow_dispatch:
  issue_comment:
    types: [created]

permissions:
  issues: write
  pull-requests: write
  contents: read

jobs:
  build-and-test:
    if: |
      github.event_name == 'pull_request' ||
      (github.event_name == 'issue_comment' && github.event.issue.pull_request && contains(github.event.comment.body, 'Run Tests:'))

    strategy:
      matrix:
        runs-on: [ubuntu-latest]
    runs-on: ${{ matrix.runs-on }}
    env:
      BRANCH_NAME: ${{ github.head_ref || github.ref_name }}
      TARGET_BRANCH: ""
      MX_CHAIN_GO_TARGET_BRANCH: ""
      MX_CHAIN_SIMULATOR_TARGET_BRANCH: ""
      MX_CHAIN_TESTING_SUITE_TARGET_BRANCH: ""

    steps:
      - name: Log Comment
        run: |
          echo "Comment body: ${{ github.event.comment.body }}"
          echo "Is PR: ${{ github.event.issue.pull_request }}"

      - name: Parse Comment for Branches
        if: github.event_name == 'issue_comment'
        run: |
          COMMENT="${{ github.event.comment.body }}"
          if echo "$COMMENT" | grep -qE "Run Test[s]?:";
          then
            if echo "$COMMENT" | grep -q "mx-chain-simulator-go:";
            then
              SIMULATOR_BRANCH=$(echo "$COMMENT" | grep "mx-chain-simulator-go:" | awk -F': ' '{print $2}')
              echo "MX_CHAIN_SIMULATOR_TARGET_BRANCH=${SIMULATOR_BRANCH}" >> $GITHUB_ENV
            fi
            if echo "$COMMENT" | grep -q "mx-chain-testing-suite:";
            then
              TESTING_SUITE_BRANCH=$(echo "$COMMENT" | grep "mx-chain-testing-suite:" | awk -F': ' '{print $2}')
              echo "MX_CHAIN_TESTING_SUITE_TARGET_BRANCH=${TESTING_SUITE_BRANCH}" >> $GITHUB_ENV
            fi
          fi

      - name: Set up Go 1.20.7
        uses: actions/setup-go@v3
        with:
          go-version: 1.20.7
        id: go

      - name: Checkout mx-chain-go
        uses: actions/checkout@v4
        with:
          repository: 'multiversx/mx-chain-go'
          ref: ${{ github.head_ref || github.ref }}
          fetch-depth: 0
          path: 'mx-chain-go'

      - name: Get Latest Commit Hash
        run: |
          cd mx-chain-go
          current_branch=$(git symbolic-ref --short HEAD)
          echo "CURRENT_BRANCH=${current_branch}" >> $GITHUB_ENV
          git fetch origin ${current_branch} --prune
          latest_commit_hash=$(git rev-parse origin/${current_branch})
          echo "LATEST_COMMIT_HASH=${latest_commit_hash}" >> $GITHUB_ENV
          echo "Latest commit hash: ${latest_commit_hash}"

      - name: Determine Target Branches
        id: target_branch
        run: |
          if [ -z "${{ env.MX_CHAIN_SIMULATOR_TARGET_BRANCH }}" ]; then
            if [[ "${{ github.event.pull_request.base.ref }}" == "main" ]]; then
              echo "MX_CHAIN_SIMULATOR_TARGET_BRANCH=main" >> $GITHUB_ENV
            elif [[ "${{ github.event.pull_request.base.ref }}" == "master" ]]; then
              echo "MX_CHAIN_SIMULATOR_TARGET_BRANCH=main" >> $GITHUB_ENV
            elif [[ "${{ github.event.pull_request.base.ref }}" == rc/* || "${{ github.event.pull_request.base.ref }}" == integrate-sys-tests-ci* ]]; then
              echo "MX_CHAIN_SIMULATOR_TARGET_BRANCH=${{ github.event.pull_request.base.ref }}" >> $GITHUB_ENV
            fi
          fi

          if [ -z "${{ env.MX_CHAIN_TESTING_SUITE_TARGET_BRANCH }}" ]; then
            if [[ "${{ github.event.pull_request.base.ref }}" == "main" ]]; then
              echo "MX_CHAIN_TESTING_SUITE_TARGET_BRANCH=main" >> $GITHUB_ENV
            elif [[ "${{ github.event.pull_request.base.ref }}" == "master" ]]; then
              echo "MX_CHAIN_TESTING_SUITE_TARGET_BRANCH=main" >> $GITHUB_ENV
            elif [[ "${{ github.event.pull_request.base.ref }}" == rc/* || "${{ github.event.pull_request.base.ref }}" == integrate-sys-tests-ci* ]]; then
              echo "MX_CHAIN_TESTING_SUITE_TARGET_BRANCH=${{ github.event.pull_request.base.ref }}" >> $GITHUB_ENV
            fi
          fi

      - name: Print Target Branches
        run: |
          echo "Current branch: ${{ env.CURRENT_BRANCH }}"
          echo "mx-chain-go target branch: ${{ env.MX_CHAIN_GO_TARGET_BRANCH }}"
          echo "mx-chain-simulator-go target branch: ${{ env.MX_CHAIN_SIMULATOR_TARGET_BRANCH }}"
          echo "mx-chain-testing-suite target branch: ${{ env.MX_CHAIN_TESTING_SUITE_TARGET_BRANCH }}"

      - name: Checkout mx-chain-simulator-go
        uses: actions/checkout@v4
        with:
          repository: 'multiversx/mx-chain-simulator-go'
          ref: ${{ env.MX_CHAIN_SIMULATOR_TARGET_BRANCH }}
          path: 'mx-chain-simulator-go'

      - name: Set up Python 3.10
        uses: actions/setup-python@v2
        with:
          python-version: '3.10'

      - name: Install Python Dependencies and Update go.mod
        run: |
          cd mx-chain-simulator-go
          pip install -r scripts/update_go_mod/requirements.txt
          python scripts/update_go_mod/update_go_mod.py $LATEST_COMMIT_HASH

      - name: Run go mod tidy and go build
        run: |
          cd mx-chain-simulator-go/cmd/chainsimulator
          go mod tidy
          go build
          echo "CHAIN_SIMULATOR_BUILD_PATH=$(pwd)" >> $GITHUB_ENV

      - name: Checkout mx-chain-testing-suite
        uses: actions/checkout@v4
        with:
          repository: 'multiversx/mx-chain-testing-suite'
          path: 'mx-chain-testing-suite'
          ref: ${{ env.MX_CHAIN_TESTING_SUITE_TARGET_BRANCH }}
          token: ${{ secrets.MVX_TESTER_GH_TOKEN }}

      - name: Install Dependencies
        run: |
          pip install -r mx-chain-testing-suite/requirements.txt
          echo "PYTHONPATH=mx-chain-testing-suite" >> $GITHUB_ENV

      - name: Test Token Permissions
        run: |
          git remote set-url origin https://x-access-token:${{ secrets.MVX_TESTER_GH_TOKEN }}@github.com/multiversx/mx-chain-testing-suite.git
          git ls-remote --heads origin


      - name: Run tests and generate HTML report
        run: |
          set +e
          pytest mx-chain-testing-suite/scenarios/ --html=report.html --self-contained-html --continue-on-collection-errors
          PYTEST_EXIT_CODE=$?
          set -e
          echo "PYTEST_EXIT_CODE=$PYTEST_EXIT_CODE" >> $GITHUB_ENV
          echo "Pytest exit code: $PYTEST_EXIT_CODE"
          if [ -f "report.html" ]; then
            echo "Report generated successfully."
            mkdir -p ./reports
            mv report.html ./reports/
          else
            echo "Report not found."
          fi

      - name: Deploy Report to GitHub Pages
        if: always()
        id: deploy_report
        run: |
          # Navigate to the mx-chain-testing-suite directory
          cd mx-chain-testing-suite

          # Configure Git user
          git config user.name "GitHub Action"
          git config user.email "action@github.com"

          # Check if the report exists
          if [ -f "../reports/report.html" ]; then
            # Ensure we're on the 'gh-pages' branch and up to date
            git fetch --all
            git checkout gh-pages || git checkout --orphan gh-pages

            # Create a new directory for the report based on the current timestamp
            TIMESTAMP=$(date +'%d%m%Y-%H%M%S')
            echo "TIMESTAMP=$TIMESTAMP" >> $GITHUB_ENV
            REPORT_DIR="reports/${BRANCH_NAME}/${TIMESTAMP}"
            mkdir -p $REPORT_DIR

            # Move the report into the new directory
            cp ../reports/report.html $REPORT_DIR/index.html

            # Add and commit the new report
            git add $REPORT_DIR/index.html
            git commit -m "Deploy Test Report at $BRANCH_NAME/$TIMESTAMP"

            # Set remote URL with authentication token
            git remote set-url origin https://x-access-token:${{ secrets.MVX_TESTER_GH_TOKEN }}@github.com/multiversx/mx-chain-testing-suite.git

            # Push changes to the remote 'gh-pages' branch
            git push --force origin gh-pages
          else
            echo "Report file not found, skipping deployment."
          fi


      - name: Update Index Page
        if: always()
        run: |
          if [ -d "docs" ]; then
            cd docs
            echo "<html><body><h1>Test Reports</h1><ul>" > index.html
            for report in $(ls ../reports); do
              echo "<li><a href='../reports/$report/index.html'>Report - $report</a></li>" >> index.html
            done
            echo "</ul></body></html>" >> index.html
            git add index.html
            git commit -m "Update Index of Reports"
            git push origin gh-pages --force
          else
            mkdir -p docs
            cd docs
            echo "<html><body><h1>Test Reports</h1><ul>" > index.html
            echo "</ul></body></html>" >> index.html
            echo "Docs directory was not found and has been created."
          fi

      - name: Comment PR with report link or error message
        if: always()
        uses: actions/github-script@v7
        env:
          TIMESTAMP: ${{ env.TIMESTAMP }}
          BRANCH_NAME: ${{ env.BRANCH_NAME }}
        with:
          github-token: ${{ secrets.GITHUB_TOKEN }}
          script: |
            const timestamp = process.env.TIMESTAMP;
            const branchName = process.env.BRANCH_NAME;
            const issue_number = context.issue.number;
            const owner = context.repo.owner;
            const repo = context.repo.repo;
            let message;

            if (timestamp && branchName && timestamp !== "" && branchName !== "") {
              const reportUrl = `https://multiversx.github.io/mx-chain-testing-suite/reports/${branchName}/${timestamp}/index.html`;
              message = `📊 **MultiversX Automated Test Report:** [View Report](${reportUrl})`;
            } else {
              message = "⚠️ No report was generated due to an error or cancellation of the process.\nPlease checkout gh action logs for details";
            }

            github.rest.issues.createComment({
              issue_number: issue_number,
              owner: owner,
              repo: repo,
              body: message
            });

      - name: Fail job if tests failed
        if: always()
        run: |
          if [ "${{ env.PYTEST_EXIT_CODE }}" != "0" ]; then
            echo "Tests failed with exit code ${{ env.PYTEST_EXIT_CODE }}"
            exit 1
          else
            echo "Tests passed successfully."
          fi
